clear all;
for k = (1:10) % 10-step prediction using 30-length original data
    Y_origin = xlsread('E:\EEG_Data\20121031083429.txt'); %Y is a 24 Dimension EEG signal
    xx_origin = Y_origin(2000+1:end,:)';  
    Y = textread('E:\RDE\code\traindata.txt'); %Y is a 24 Dimension EEG signal
    xx = Y(1:end,:);  
    
    trainlength = 30+k-1;
    traindata = xx(:,1:trainlength);
    dlmwrite('E:\RDE\code\traindata.txt',traindata,'delimiter','\t','newline','pc');

    D = size(traindata,1); %D = 24

    s = 2000;% the number of non-delay embedding
    L = 6; % the value of L is calculated by FNN-cao

    pre_value = [];
    for j = 1:D
        prediction = zeros(1,s);
        indexr = zeros(s,D);
        score = zeros(1,s);
        % making predictions with RDE using KDE schema;

        for i=1:s
            disp(['The process has finished ' num2str(j) ' /24 ''.'])
            indexr(i,:)=randperm(D);
            predictions(i)=myprediction_gp(traindata(indexr(i,1:L),1:trainlength-1),traindata(j,2:trainlength),traindata(indexr(i,1:L),trainlength));% other kinds of fitting method could be used here
        end
        pp=outlieromit(predictions);% exclude the outliers
        [F,XI]=ksdensity(pp,linspace(min(pp),max(pp),10000));% use kernal density estimation to approximate the probability distribution
        prediction=sum(XI.*F/sum(F)); % use expectation as the final one-step predicted value 
        ystd=std(pp);
        pre_value(end+1) = prediction;
    end


    %     % plot the result
    %     figure
    %     plot(xx(j,1:trainlength+1),'-*');% real data
    %     hold on;
    %     plot(trainlength+1,prediction,'ro','MarkerSize',8); %predicted data
    % 
    %     figure
    %     plot(XI,F); % probablity distribution generated by RDE framework
    %     hold on
    %     plot(xx(j,trainlength+1),max(F),'bo','MarkerFaceColor','r'); % true value of the target variable
    traindata(:,end+1) = pre_value
    dlmwrite('E:\RDE\code\traindata.txt',traindata,'delimiter','\t','newline','pc');
end

